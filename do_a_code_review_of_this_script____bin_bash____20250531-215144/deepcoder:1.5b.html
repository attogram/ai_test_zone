<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  body { font-family: monospace; }
  textarea { border: 1px solid #cccccc; white-space: pre-wrap; width: 90%; }
  header, footer { background-color: #f0f0f0; padding: 10px; }
  .menu { font-size: small; }
  table, td, th { border-collapse: collapse; }
  td, th { border: 1px solid #cccccc; padding: 5px; text-align: right; }
  .left { text-align: left; }
  li { margin: 5px; }
</style><title>ollama multirun: deepcoder:1.5b</title></head><body>
<header><a href='../index.html'>ollama multirun</a>: <a href='./index.html'>do_a_code_review_of_this_script____bin_bash___</a>: <b>deepcoder:1.5b</b><br /><br />
<span class='menu'>models: 
<a href='./codellama:7b.html'>codellama:7b</a> 
<b>deepcoder:1.5b</b> 
<a href='./dolphin3:8b.html'>dolphin3:8b</a> 
<a href='./gemma:2b.html'>gemma:2b</a> 
<a href='./granite3.3:2b.html'>granite3.3:2b</a> 
<a href='./llama2-uncensored:7b.html'>llama2-uncensored:7b</a> 
<a href='./mistral:7b.html'>mistral:7b</a> 
<a href='./qwen2.5-coder:7b.html'>qwen2.5-coder:7b</a> 
<a href='./qwen3:1.7b.html'>qwen3:1.7b</a> 
</span>
</header>
<p>Prompt: (<a href='./prompt.txt'>raw</a>) (<a href='./do_a_code_review_of_this_script____bin_bash___.prompt.yaml'>yaml</a>)
  words:971  bytes:8534<br />
<textarea readonly rows='10'>Do a code review of this script:

#!/bin/bash
#
# ollama multirun
#
# Bash shell script to run a prompt against all models in ollama, and save the output as web pages
#
# Usage:
#  - Enter prompt manually:  ./multirun.sh
#  - Enter prompt from file: ./multirun.sh &lt; prompt.txt
#  - Enter prompt from pipe: echo &quot;your prompt&quot; | ./multirun.sh
#                            echo &quot;summarize this file: $(cat filename)&quot; | ./multirun.sh
#
# Requires: ollama, bash, expect, awk, sed, tr, wc

NAME=&quot;ollama multirun&quot;
VERSION=&quot;2.0&quot;
URL=&quot;https://github.com/attogram/ollama-multirun&quot;
RESULTS_DIRECTORY=&quot;results&quot;

echo; echo &quot;$NAME v$VERSION&quot;; echo

function setModels {
  models=$(ollama list | awk &#39;{if (NR &gt; 1) print $1}&#39; | sort) # Get list of models, sorted alphabetically
  echo &quot;Models:&quot;; echo &quot;$models&quot;; echo
  if [ -z &quot;$models&quot; ]; then
    echo &quot;No models found. Please install models with &#39;ollama pull &lt;model-name&gt;&#39;&quot;
    exit 1
  fi
}

function createResultsDirectory {
  tag=$(safeTag &quot;$prompt&quot;)
  directory=&quot;${RESULTS_DIRECTORY}/${tag}_$(date &#39;+%Y%m%d-%H%M%S&#39;)&quot;
  echo; echo &quot;Creating: $directory/&quot;
  mkdir -p &quot;$directory&quot;
}

function setPrompt {
  if [ -t 0 ]; then
    echo &quot;Enter prompt:&quot;;
    read -r prompt
  else
    prompt=$(cat)  # get piped input
  fi
  echo; echo &quot;Prompt:&quot;; echo &quot;$prompt&quot;
}

function savePrompt {
  promptFile=&quot;$directory/prompt.txt&quot;
  echo &quot;Creating: $promptFile&quot;
  echo &quot;$prompt&quot; &gt; &quot;$promptFile&quot;

  # Github Prompt YAML: https://docs.github.com/en/github-models/use-github-models/storing-prompts-in-github-repositories
  echo &quot;Creating: $directory/$tag.prompt.yaml&quot;
  (
    echo &quot;name: $tag&quot;
    echo &quot;description: &quot;
    echo &quot;model: &quot;
    echo &quot;messages:&quot;
    echo &quot;  - role: system&quot;
    echo &quot;    content:&quot;
    echo &quot;  - role: user&quot;
    echo &quot;    content: |&quot;
    while IFS= read -r line; do
      echo &quot;      $line&quot;
    done &lt;&lt;&lt; &quot;$prompt&quot;
  ) &gt; &quot;$directory/$tag.prompt.yaml&quot;
}

function showPrompt {
    promptWords=$(wc -w &lt; &quot;$promptFile&quot; | awk &#39;{print $1}&#39;)
    promptBytes=$(wc -c &lt; &quot;$promptFile&quot; | awk &#39;{print $1}&#39;)
    echo &quot;&lt;p&gt;Prompt: (&lt;a href=&#39;./prompt.txt&#39;&gt;raw&lt;/a&gt;) (&lt;a href=&#39;./${tag}.prompt.yaml&#39;&gt;yaml&lt;/a&gt;)&quot;
    echo &quot;  words:$promptWords  bytes:$promptBytes&lt;br /&gt;&quot;
    textarea &quot;$prompt&quot; 0 10 # 0 padding, max 10 lines
    echo &quot;&lt;/p&gt;&quot;
}

function textarea() {
  local content=&quot;$1&quot; # Get the input
  if [ -z &quot;$content&quot; ]; then
    content=&quot;&quot;
  fi
  local padding=&quot;$2&quot;
  if [ -z &quot;$padding&quot; ]; then
    padding=0
  fi
  local max=&quot;$3&quot;
  if [ -z &quot;$max&quot; ]; then
    max=25
  fi
  local lines=$(echo &quot;$content
&quot; | wc -l) # Get number of lines in content
  lines=$((lines + padding))
  if [ &quot;$lines&quot; -gt &quot;$max&quot; ]; then
    lines=$max
  fi
  content=$(echo &quot;$content&quot; | sed &#39;s/&amp;/\&amp;amp;/g; s/&lt;/\&amp;lt;/g; s/&gt;/\&amp;gt;/g; s/&quot;/\&amp;quot;/g; s/&#39;&quot;&#39;&quot;&#39;/\&amp;#39;/g&#39;) # Escape HTML special characters
  echo &quot;&lt;textarea readonly rows=&#39;$lines&#39;&gt;${content}&lt;/textarea&gt;&quot;
}

function safeTag() {
    local input=&quot;$1&quot; # Get the input
    input=${input:0:50} # Truncate to first 50 characters
    input=$(echo &quot;$input&quot; | tr &#39;[:upper:]&#39; &#39;[:lower:]&#39;) # Convert to lowercase
    input=$(echo &quot;$input&quot; | sed &quot;s/ /_/g&quot;) # Replace spaces with underscores
    input=$(echo &quot;$input&quot; | sed &#39;s/[^a-zA-Z0-9_]/_/g&#39; | tr -cd &#39;a-zA-Z0-9_&#39;)
    echo &quot;$input&quot; # Output the sanitized string
}

function clear_model {
  echo &quot;Clearing: $1&quot;
  local run=&quot;ollama run $1&quot;
  expect -c &quot;spawn $run
    sleep 1;
    send -- \&quot;/clear
\&quot;; 
    sleep 1;
    send -- \&quot;/bye
\&quot;; 
    interact;&quot;
  echo &quot;Stopping: $1&quot;
  ollama stop &quot;$1&quot;
}

function setHeaderAndFooter {
  HEADER=$(cat &lt;&lt;EOF
&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;en&quot;&gt;
&lt;head&gt;
&lt;meta charset=&quot;UTF-8&quot;&gt;
&lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot;&gt;
&lt;style&gt;
  body { font-family: monospace; }
  textarea { border: 1px solid #cccccc; white-space: pre-wrap; width: 90%; }
  header, footer { background-color: #f0f0f0; padding: 10px; }
  .menu { font-size: small; }
  table, td, th { border-collapse: collapse; }
  td, th { border: 1px solid #cccccc; padding: 5px; text-align: right; }
  .left { text-align: left; }
  li { margin: 5px; }
&lt;/style&gt;
EOF
  )

  FOOTER=$(cat &lt;&lt;EOF
&lt;footer&gt;&lt;p&gt;Generated with &lt;a target=&#39;$NAME&#39; href=&#39;$URL&#39;&gt;$NAME&lt;/a&gt; v$VERSION&lt;/p&gt;&lt;/footer&gt;
&lt;/body&gt;&lt;/html&gt;
EOF
  )
}

function createMenu {
  local currentModel=&quot;$1&quot;
  echo &quot;&lt;span class=&#39;menu&#39;&gt;models: &quot;
  for modelName in $models; do
    if [ &quot;$modelName&quot; == &quot;$currentModel&quot; ]; then
      echo &quot;&lt;b&gt;$modelName&lt;/b&gt; &quot;
    else
      echo &quot;&lt;a href=&#39;./$modelName.html&#39;&gt;$modelName&lt;/a&gt; &quot;
    fi
  done
  echo &#39;&lt;/span&gt;&#39;;
}

function createResultsIndexFile {
  resultsIndexFile=&quot;${RESULTS_DIRECTORY}/index.html&quot;
  echo &quot;Creating: $resultsIndexFile&quot;
  {
    echo &quot;$HEADER&lt;title&gt;$NAME: results&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&quot;
    echo &quot;&lt;header&gt;&lt;p&gt;&lt;b&gt;$NAME&lt;/b&gt;&lt;/p&gt;&lt;/header&gt;&quot;
    echo &quot;&lt;ul&gt;&quot;
    for dir in &quot;$RESULTS_DIRECTORY&quot;/*; do
      if [ -d &quot;$dir&quot; ]; then
        echo &quot;&lt;li&gt;&lt;a href=&#39;${dir##*/}/index.html&#39;&gt;${dir##*/}&lt;/a&gt;&lt;/li&gt;&quot;
      fi
    done
    echo &quot;&lt;/ul&gt;&quot;
    echo &quot;&lt;br /&gt;&lt;br /&gt;&lt;p&gt;Created: $(date &#39;+%Y-%m-%d %H:%M:%S&#39;)&lt;/p&gt;&quot;
    echo &quot;$FOOTER&quot;
  } &gt; $resultsIndexFile
}

function createIndexFile {
  indexFile=&quot;$directory/index.html&quot;
  echo &quot;Creating: $indexFile&quot;
  {
    echo &quot;$HEADER&lt;title&gt;$NAME: $tag&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&quot;
    echo &quot;&lt;header&gt;&lt;a href=&#39;../index.html&#39;&gt;$NAME&lt;/a&gt;: &lt;b&gt;$tag&lt;/b&gt;&lt;br /&gt;&lt;br /&gt;&quot;
    createMenu &quot;index&quot;
    echo  &quot;&lt;/header&gt;&quot;
    showPrompt
    cat &lt;&lt;- &quot;EOF&quot;
&lt;table&gt;
  &lt;tr&gt;
    &lt;th class=&#39;left&#39;&gt;model&lt;/th&gt;
    &lt;th&gt;words&lt;/th&gt;
    &lt;th&gt;bytes&lt;/th&gt;
    &lt;th&gt;total&lt;br /&gt;duration&lt;/th&gt;
    &lt;th&gt;load&lt;br /&gt;duration&lt;/th&gt;
    &lt;th&gt;prompt eval&lt;br /&gt;count&lt;/th&gt;
    &lt;th&gt;prompt eval&lt;br /&gt;duration&lt;/th&gt;
    &lt;th&gt;prompt eval&lt;br /&gt;rate&lt;/th&gt;
    &lt;th&gt;eval&lt;br /&gt;count&lt;/th&gt;
    &lt;th&gt;eval&lt;br /&gt;duration&lt;/th&gt;
    &lt;th&gt;eval&lt;br /&gt;rate&lt;/th&gt;
  &lt;/tr&gt;
EOF
  } &gt; &quot;$indexFile&quot;
}

function addModelToIndexFile {
    responseWords=$(wc -w &lt; &quot;$modelFile&quot; | awk &#39;{print $1}&#39;)
    responseBytes=$(wc -c &lt; &quot;$modelFile&quot; | awk &#39;{print $1}&#39;)
    (
        echo &quot;&lt;tr&gt;&lt;td class=&#39;left&#39;&gt;&lt;a href=&#39;./$model.html&#39;&gt;$model&lt;/a&gt;&lt;/td&gt;&lt;td &gt;$responseWords&lt;/td&gt;&lt;td&gt;$responseBytes&lt;/td&gt;&quot;
        while read -r line; do
          value=$(echo &quot;$line&quot; | cut -d &#39;:&#39; -f2) # parse the stats file per line, splitting on : character, getting the second part as the value
          if [[ -n &quot;$value&quot; ]]; then
            echo &quot;&lt;td&gt;${value}&lt;/td&gt;&quot;;
          fi
        done &lt; &quot;$statsFile&quot;
        echo &quot;&lt;/tr&gt;&quot;
    ) &gt;&gt; &quot;$indexFile&quot;
}

function finishIndexFile {
  {
    echo &quot;&lt;/table&gt;&quot;
    echo &quot;&lt;br /&gt;&lt;br /&gt;&lt;p&gt;Created: $(date &#39;+%Y-%m-%d %H:%M:%S&#39;)&lt;/p&gt;&quot;
    echo &quot;$FOOTER&quot;
  } &gt;&gt; &quot;$indexFile&quot;
}

function getStats {
    stats=&quot;$(cat &quot;$statsFile&quot;)&quot; # get content of stats file
    stats=&quot;total${stats#*total}&quot; # remove everything before the first occurrence of word &#39;total&#39;
    stats=${stats%%&quot;$(tail -n1 &lt;&lt;&lt;&quot;$stats&quot;)&quot;} # remove the last line
    echo &quot;$stats&quot; &gt; &quot;$statsFile&quot; # save cleaned stats
}

function createModelFile {
      modelHtmlFile=&quot;$directory/$model.html&quot;
      echo &quot;Creating: $modelHtmlFile&quot;
      resultsWords=$(wc -w &lt; &quot;$modelFile&quot; | awk &#39;{print $1}&#39;)
      resultsBytes=$(wc -c &lt; &quot;$modelFile&quot; | awk &#39;{print $1}&#39;)
      {
        echo &quot;$HEADER&lt;title&gt;$NAME: $model&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&quot;
        echo &quot;&lt;header&gt;&lt;a href=&#39;../index.html&#39;&gt;$NAME&lt;/a&gt;: &lt;a href=&#39;./index.html&#39;&gt;$tag&lt;/a&gt;: &lt;b&gt;$model&lt;/b&gt;&lt;br /&gt;&lt;br /&gt;&quot;
        createMenu &quot;$model&quot;
        echo &quot;&lt;/header&gt;&quot;
        showPrompt
        echo &quot;&lt;p&gt;Output: $model (&lt;a href=&#39;./$model.txt&#39;&gt;raw&lt;/a&gt;)  words:$resultsWords  bytes:$resultsBytes&lt;br /&gt;&quot;
        textarea &quot;$(cat &quot;$modelFile&quot;)&quot; 5 30 # 5 padding, max 30 lines
        echo &quot;&lt;/p&gt;&quot;
        echo &quot;&lt;p&gt;Stats: $model (&lt;a href=&#39;./$model.stats.txt&#39;&gt;raw&lt;/a&gt;)&lt;br /&gt;&quot;
        textarea &quot;$stats&quot; 0 10 # 0 padding, max 10 lines
        echo &quot;&lt;/p&gt;&quot;
        echo &quot;&lt;p&gt;ollama Model Info: &lt;a target=&#39;ollama&#39; href=&#39;https://ollama.com/library/${model}&#39;&gt;$model&lt;/a&gt;&lt;/p&gt;&quot;
        echo &quot;&lt;p&gt;Created: $(date &#39;+%Y-%m-%d %H:%M:%S&#39;)&lt;/p&gt;&quot;
        echo &quot;$FOOTER&quot;
      } &gt; &quot;$modelHtmlFile&quot;
}

setModels
setPrompt
createResultsDirectory
savePrompt
setHeaderAndFooter
createResultsIndexFile
createIndexFile

# Loop through each model and run it with the given prompt
for model in $models; do
    echo; echo &quot;Running model: $model&quot;
    modelFile=&quot;$directory/$model.txt&quot;
    statsFile=&quot;$directory/$model.stats.txt&quot;
    echo &quot;Creating: $modelFile&quot;
    echo &quot;Creating: $statsFile&quot;
    ollama run --verbose &quot;$model&quot; -- &quot;${prompt}&quot; &gt; &quot;$modelFile&quot; 2&gt; &quot;$statsFile&quot;
    clear_model &quot;$model&quot;
    getStats
    createModelFile
    addModelToIndexFile
done

finishIndexFile

echo; echo &quot;Done: $directory/&quot;</textarea>
</p>
<p>Output: deepcoder:1.5b (<a href='./deepcoder:1.5b.txt'>raw</a>)  words:724  bytes:4648<br />
<textarea readonly rows='30'>&lt;think&gt;
Okay, I need to do a code review of the given script. Let me go through it step by step.

First, looking at the script name and description, it&#39;s about running a prompt against all models in ollama and saving the output as web pages. The user provided some commands, so the script should handle multiple models.

The script starts with some basic setup, including dependencies like ollama, bash, etc. The function setModels fetches the list of models and sorts them. That makes sense.

Next, there&#39;s a createResultsDirectory function which creates a directory based on a tag. But wait, the tag is generated using safeTag, which truncates and sanitizes the input. I&#39;m wondering if this could cause issues if the input isn&#39;t properly sanitized.

The setPrompt function checks if the user wants to enter a prompt or use predefined values. That seems okay.

Now, looking at savePrompt, it creates a prompt file with YAML structure. The content is read from a file or generated by the loop. But I notice that in the code, there&#39;s an echo for &quot;Output: $model&quot; and then uses &quot;$modelFile&quot; which might not be defined correctly. Also, when creating the prompt, it reads from $modelFile but doesn&#39;t set it properly.

In the loop part, for each model, it runs ollama with the given prompt. But wait, in the code, after running, it calls clear_model and get_stats, then createModelFile. However, I see that the loop is at the bottom of the script, so perhaps it&#39;s not correctly structured.

Looking at the functions like addModelToIndexFile, they read stats from a file and write to model files. But in savePrompt, when creating the prompt, it uses &quot;$modelFile&quot; which might be incorrect because $modelFile is the directory for the model stats, not the actual HTML file.

Also, in the loop, after running ollama, there&#39;s a textarea function that writes the input into a textarea element. But I don&#39;t see any use of this in the loop&#39;s savePrompt section. Maybe that&#39;s unnecessary and could cause issues if it&#39;s not used elsewhere.

Another point is error handling. For example, when creating directories or models, if they don&#39;t exist, it might throw errors. Also, the functions like setHeaderAndFooter are defined but not used anywhere except in the loop, which might be a problem because they need to be called from within the script&#39;s context.

I also notice that the function clear_model is present but may not be properly handling all cases, especially when multiple models are being processed. It might cause issues if called multiple times or not with the correct arguments.

The script seems to have some logical structure but lacks proper error handling and may have some redundancy. For example, functions like addModelToIndexFile are defined but not used in the main logic except for creating HTML files from stats. This could lead to duplicated code and might need more attention.

In summary, the code has good structure but needs improvement in error handling, function calls, and ensuring that all necessary parts are connected without redundancy.
&lt;/think&gt;

Here is a step-by-step code review of the provided script:

1. **Function Definitions vs. Usage**:
   - Some functions like `addModelToIndexFile` and `createResultsIndexFile` are defined but not used in the main logic, leading to duplication and potential issues.

2. **Directory Creation Functions**:
   - The `createResultsDirectory` function creates directories for each model&#39;s results. However, it lacks proper error handling and may cause issues with existing directories.
   
3. **Loop Structure**:
   - The loop processing models is at the bottom of the script but not connected to other functions like `savePrompt`, leading to isolated code.

4. **Error Handling and Validation**:
   - Functions like `setModels` return an error code, which could be useful for debugging but may complicate validation checks.

5. **Function Calls Without Context**:
   - The functions `addModelToIndexFile` and `createResultsIndexFile` are defined but not called within the main loop logic, causing potential duplication and errors.

6. **Redundant Code**:
   - Functions like `setHeaderAndFooter` and `clear_model` are referenced in comments but not used elsewhere, leading to redundancy.

To improve the code:

- Ensure all functions are properly connected.
- Add error handling for each function call.
- Remove duplicate code by consolidating logic where possible.
- Use appropriate variables for results storage (e.g., `$results.html`) instead of creating new files repeatedly.

The revised script should focus on organizing these elements to ensure functionality and maintainability.</textarea>
</p>
<p>Stats: deepcoder:1.5b (<a href='./deepcoder:1.5b.stats.txt'>raw</a>)<br />
<textarea readonly rows='9'>total duration:       1m46.403845381s
load duration:        1.65937334s
prompt eval count:    2612 token(s)
prompt eval duration: 50.160984088s
prompt eval rate:     52.07 tokens/s
eval count:           968 token(s)
eval duration:        54.581699025s
eval rate:            17.73 tokens/s</textarea>
</p>
<p>ollama Model Info: <a target='ollama' href='https://ollama.com/library/deepcoder:1.5b'>deepcoder:1.5b</a></p>
<p>Created: 2025-05-31 22:00:38</p>
<footer><p>Generated with <a target='ollama multirun' href='https://github.com/attogram/ollama-multirun'>ollama multirun</a> v2.0</p></footer>
</body></html>
